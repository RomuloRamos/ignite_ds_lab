import{a as j}from"./_commonjsHelpers-042e6b4d.js";import{s as p}from"./index-d475d2ea.js";import{r as k}from"./index-da07a199.js";const D={},P=Object.freeze(Object.defineProperty({__proto__:null,default:D},Symbol.toStringTag,{value:"Module"})),H=j(P),{addons:x}=__STORYBOOK_MODULE_PREVIEW_API__,{once:L,logger:U}=__STORYBOOK_MODULE_CLIENT_LOGGER__,{FORCE_REMOUNT:w,STORY_RENDER_PHASE_CHANGED:M,SET_CURRENT_STORY:v,IGNORED_EXCEPTION:Y}=__STORYBOOK_MODULE_CORE_EVENTS__;var $=(r=>(r.DONE="done",r.ERROR="error",r.ACTIVE="active",r.WAITING="waiting",r))($||{}),m={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},T={start:!1,back:!1,goto:!1,next:!1,end:!1},B=new Error("This function ran after the play function completed. Did you forget to `await` it?"),I=r=>Object.prototype.toString.call(r)==="[object Object]",K=r=>Object.prototype.toString.call(r)==="[object Module]",G=r=>{if(!I(r)&&!K(r))return!1;if(r.constructor===void 0)return!0;let s=r.constructor.prototype;return!(!I(s)||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)},z=r=>{try{return new r.constructor}catch{return{}}},S=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),N=(r,s=!1)=>{let u=(s?r.shadowCalls:r.calls).filter(o=>o.retain);if(!u.length)return;let d=new Map(Array.from(r.callRefsByResult.entries()).filter(([,o])=>o.retain));return{cursor:u.length,calls:u,callRefsByResult:d}},q=class{constructor(){this.initialized=!1,this.channel=x.getChannel(),this.state=p.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let r=({storyId:e,isPlaying:a=!0,isDebugging:t=!1})=>{let l=this.getState(e);this.setState(e,{...S(),...N(l,t),shadowCalls:t?l.shadowCalls:[],chainedCallIds:t?l.chainedCallIds:new Set,playUntil:t?l.playUntil:void 0,isPlaying:a,isDebugging:t}),this.sync(e)};this.channel.on(w,r),this.channel.on(M,({storyId:e,newPhase:a})=>{let{isDebugging:t}=this.getState(e);this.setState(e,{renderPhase:a}),a==="preparing"&&t&&r({storyId:e}),a==="playing"&&r({storyId:e,isDebugging:t}),a==="played"&&this.setState(e,{isLocked:!1,isPlaying:!1,isDebugging:!1}),a==="errored"&&this.setState(e,{isLocked:!1,isPlaying:!1})}),this.channel.on(v,()=>{this.initialized?this.cleanup():this.initialized=!0});let s=({storyId:e,playUntil:a})=>{this.getState(e).isDebugging||this.setState(e,({calls:l})=>({calls:[],shadowCalls:l.map(n=>({...n,status:"waiting"})),isDebugging:!0}));let t=this.getLog(e);this.setState(e,({shadowCalls:l})=>{var i;if(a||!t.length)return{playUntil:a};let n=l.findIndex(c=>c.id===t[0].callId);return{playUntil:(i=l.slice(0,n).filter(c=>c.interceptable&&!c.ancestors.length).slice(-1)[0])==null?void 0:i.id}}),this.channel.emit(w,{storyId:e,isDebugging:!0})},u=({storyId:e})=>{var l;let a=this.getLog(e).filter(n=>!n.ancestors.length),t=a.reduceRight((n,i,c)=>n>=0||i.status==="waiting"?n:c,-1);s({storyId:e,playUntil:(l=a[t-1])==null?void 0:l.callId})},d=({storyId:e,callId:a})=>{var g;let{calls:t,shadowCalls:l,resolvers:n}=this.getState(e),i=t.find(({id:_})=>_===a),c=l.find(({id:_})=>_===a);if(!i&&c&&Object.values(n).length>0){let _=(g=this.getLog(e).find(f=>f.status==="waiting"))==null?void 0:g.callId;c.id!==_&&this.setState(e,{playUntil:c.id}),Object.values(n).forEach(f=>f())}else s({storyId:e,playUntil:a})},o=({storyId:e})=>{var t;let{resolvers:a}=this.getState(e);if(Object.values(a).length>0)Object.values(a).forEach(l=>l());else{let l=(t=this.getLog(e).find(n=>n.status==="waiting"))==null?void 0:t.callId;l?s({storyId:e,playUntil:l}):h({storyId:e})}},h=({storyId:e})=>{this.setState(e,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(e).resolvers).forEach(a=>a())};this.channel.on(m.START,s),this.channel.on(m.BACK,u),this.channel.on(m.GOTO,d),this.channel.on(m.NEXT,o),this.channel.on(m.END,h)}getState(r){return this.state[r]||S()}setState(r,s){let u=this.getState(r),d=typeof s=="function"?s(u):s;this.state={...this.state,[r]:{...u,...d}},p.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((s,[u,d])=>{let o=N(d);return o&&(s[u]=Object.assign(S(),o)),s},{});let r={controlStates:T,logItems:[]};this.channel.emit(m.SYNC,r),p.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(r){let{calls:s,shadowCalls:u}=this.getState(r),d=[...u];s.forEach((h,e)=>{d[e]=h});let o=new Set;return d.reduceRight((h,e)=>(e.args.forEach(a=>{a!=null&&a.__callId__&&o.add(a.__callId__)}),e.path.forEach(a=>{a.__callId__&&o.add(a.__callId__)}),(e.interceptable||e.exception)&&!o.has(e.id)&&(h.unshift({callId:e.id,status:e.status,ancestors:e.ancestors}),o.add(e.id)),h),[])}instrument(r,s){if(!G(r))return r;let{mutate:u=!1,path:d=[]}=s;return Object.keys(r).reduce((o,h)=>{let e=r[h];return typeof e!="function"?(o[h]=this.instrument(e,{...s,path:d.concat(h)}),o):typeof e.__originalFn__=="function"?(o[h]=e,o):(o[h]=(...a)=>this.track(h,e,a,s),o[h].__originalFn__=e,Object.defineProperty(o[h],"name",{value:h,writable:!1}),Object.keys(e).length>0&&Object.assign(o[h],this.instrument({...e},{...s,path:d.concat(h)})),o)},u?r:z(r))}track(r,s,u,d){var _,f,b,O;let o=((_=u==null?void 0:u[0])==null?void 0:_.__storyId__)||((O=(b=(f=p.__STORYBOOK_PREVIEW__)==null?void 0:f.selectionStore)==null?void 0:b.selection)==null?void 0:O.storyId),{cursor:h,ancestors:e}=this.getState(o);this.setState(o,{cursor:h+1});let a=`${e.slice(-1)[0]||o} [${h}] ${r}`,{path:t=[],intercept:l=!1,retain:n=!1}=d,i=typeof l=="function"?l(r,t):l,c={id:a,cursor:h,storyId:o,ancestors:e,path:t,method:r,args:u,interceptable:i,retain:n},g=(i&&!e.length?this.intercept:this.invoke).call(this,s,c,d);return this.instrument(g,{...d,mutate:!0,path:[{__callId__:c.id}]})}intercept(r,s,u){let{chainedCallIds:d,isDebugging:o,playUntil:h}=this.getState(s.storyId),e=d.has(s.id);return!o||e||h?(h===s.id&&this.setState(s.storyId,{playUntil:void 0}),this.invoke(r,s,u)):new Promise(a=>{this.setState(s.storyId,({resolvers:t})=>({isLocked:!1,resolvers:{...t,[s.id]:a}}))}).then(()=>(this.setState(s.storyId,a=>{let{[s.id]:t,...l}=a.resolvers;return{isLocked:!0,resolvers:l}}),this.invoke(r,s,u)))}invoke(r,s,u){let{callRefsByResult:d,renderPhase:o}=this.getState(s.storyId),h=t=>{var l,n;if(d.has(t))return d.get(t);if(t instanceof Array)return t.map(h);if(t instanceof Date)return{__date__:{value:t.toISOString()}};if(t instanceof Error){let{name:i,message:c,stack:g}=t;return{__error__:{name:i,message:c,stack:g}}}if(t instanceof RegExp){let{flags:i,source:c}=t;return{__regexp__:{flags:i,source:c}}}if(t instanceof p.window.HTMLElement){let{prefix:i,localName:c,id:g,classList:_,innerText:f}=t,b=Array.from(_);return{__element__:{prefix:i,localName:c,id:g,classNames:b,innerText:f}}}return typeof t=="function"?{__function__:{name:t.name}}:typeof t=="symbol"?{__symbol__:{description:t.description}}:typeof t=="object"&&((l=t==null?void 0:t.constructor)!=null&&l.name)&&((n=t==null?void 0:t.constructor)==null?void 0:n.name)!=="Object"?{__class__:{name:t.constructor.name}}:Object.prototype.toString.call(t)==="[object Object]"?Object.fromEntries(Object.entries(t).map(([i,c])=>[i,h(c)])):t},e={...s,args:s.args.map(h)};s.path.forEach(t=>{t!=null&&t.__callId__&&this.setState(s.storyId,({chainedCallIds:l})=>({chainedCallIds:new Set(Array.from(l).concat(t.__callId__))}))});let a=t=>{if(t instanceof Error){let{name:l,message:n,stack:i,callId:c=s.id}=t,g={name:l,message:n,stack:i,callId:c};if(this.update({...e,status:"error",exception:g}),this.setState(s.storyId,_=>({callRefsByResult:new Map([...Array.from(_.callRefsByResult.entries()),[t,{__callId__:s.id,retain:s.retain}]])})),s.ancestors.length)throw Object.prototype.hasOwnProperty.call(t,"callId")||Object.defineProperty(t,"callId",{value:s.id}),t;if(t!==B)throw U.warn(t),Y}throw t};try{if(o==="played"&&!s.retain)throw B;let t=(u.getArgs?u.getArgs(s,this.getState(s.storyId)):s.args).map(n=>typeof n!="function"||Object.keys(n).length?n:(...i)=>{let{cursor:c,ancestors:g}=this.getState(s.storyId);this.setState(s.storyId,{cursor:0,ancestors:[...g,s.id]});let _=()=>this.setState(s.storyId,{cursor:c,ancestors:g}),f=!1;try{let b=n(...i);return b instanceof Promise?(f=!0,b.finally(_)):b}finally{f||_()}}),l=r(...t);return l&&["object","function","symbol"].includes(typeof l)&&this.setState(s.storyId,n=>({callRefsByResult:new Map([...Array.from(n.callRefsByResult.entries()),[l,{__callId__:s.id,retain:s.retain}]])})),this.update({...e,status:l instanceof Promise?"active":"done"}),l instanceof Promise?l.then(n=>(this.update({...e,status:"done"}),n),a):l}catch(t){return a(t)}}update(r){this.channel.emit(m.CALL,r),this.setState(r.storyId,({calls:s})=>{let u=s.concat(r).reduce((d,o)=>Object.assign(d,{[o.id]:o}),{});return{calls:Object.values(u).sort((d,o)=>d.id.localeCompare(o.id,void 0,{numeric:!0}))}}),this.sync(r.storyId)}sync(r){let s=()=>{var l;let{isLocked:u,isPlaying:d}=this.getState(r),o=this.getLog(r),h=(l=o.filter(({ancestors:n})=>!n.length).find(n=>n.status==="waiting"))==null?void 0:l.callId,e=o.some(n=>n.status==="active");if(u||e||o.length===0){let n={controlStates:T,logItems:o};this.channel.emit(m.SYNC,n);return}let a=o.some(n=>n.status==="done"||n.status==="error"),t={controlStates:{start:a,back:a,goto:!0,next:d,end:d},logItems:o,pausedAt:h};this.channel.emit(m.SYNC,t)};this.setState(r,({syncTimeout:u})=>(clearTimeout(u),{syncTimeout:setTimeout(s,0)}))}};function X(r,s={}){var u,d,o,h;try{let e=!1,a=!1;return(d=(u=p.window.location)==null?void 0:u.search)!=null&&d.includes("instrument=true")?e=!0:(h=(o=p.window.location)==null?void 0:o.search)!=null&&h.includes("instrument=false")&&(a=!0),p.window.parent===p.window&&!e||a?r:(p.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(p.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new q),p.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(r,s))}catch(e){return L.warn(e),r}}var y={exports:{}};y.exports;var C;function J(){return C||(C=1,function(r){const s=(n,i)=>(...c)=>`\x1B[${n(...c)+i}m`,u=(n,i)=>(...c)=>{const g=n(...c);return`\x1B[${38+i};5;${g}m`},d=(n,i)=>(...c)=>{const g=n(...c);return`\x1B[${38+i};2;${g[0]};${g[1]};${g[2]}m`},o=n=>n,h=(n,i,c)=>[n,i,c],e=(n,i,c)=>{Object.defineProperty(n,i,{get:()=>{const g=c();return Object.defineProperty(n,i,{value:g,enumerable:!0,configurable:!0}),g},enumerable:!0,configurable:!0})};let a;const t=(n,i,c,g)=>{a===void 0&&(a=k());const _=g?10:0,f={};for(const[b,O]of Object.entries(a)){const E=b==="ansi16"?"ansi":b;b===i?f[E]=n(c,_):typeof O=="object"&&(f[E]=n(O[i],_))}return f};function l(){const n=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[c,g]of Object.entries(i)){for(const[_,f]of Object.entries(g))i[_]={open:`\x1B[${f[0]}m`,close:`\x1B[${f[1]}m`},g[_]=i[_],n.set(f[0],f[1]);Object.defineProperty(i,c,{value:g,enumerable:!1})}return Object.defineProperty(i,"codes",{value:n,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",e(i.color,"ansi",()=>t(s,"ansi16",o,!1)),e(i.color,"ansi256",()=>t(u,"ansi256",o,!1)),e(i.color,"ansi16m",()=>t(d,"rgb",h,!1)),e(i.bgColor,"ansi",()=>t(s,"ansi16",o,!0)),e(i.bgColor,"ansi256",()=>t(u,"ansi256",o,!0)),e(i.bgColor,"ansi16m",()=>t(d,"rgb",h,!0)),i}Object.defineProperty(r,"exports",{enumerable:!0,get:l})}(y)),y.exports}var R,A;function Q(){return A||(A=1,R={stdout:!1,stderr:!1}),R}export{Q as a,H as b,X as i,J as r};
//# sourceMappingURL=browser-c428a01a.js.map
